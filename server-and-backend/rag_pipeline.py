# -*- coding: utf-8 -*-
"""rag_pipeline.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/16QTn8jtIweHGV1sQ29Fr0Ah6g_3TCzux
"""

import os
import sys
from typing import List, Dict # type ì •í•˜ê¸°

# .env íŒŒì¼ ë¡œë“œ(API Key ë³´ì•ˆ)
from dotenv import load_dotenv
load_dotenv()

# LangChain, Google AI ì„í¬íŠ¸
from langchain_google_genai import ChatGoogleGenerativeAI, GoogleGenerativeAIEmbeddings
from langchain_community.document_loaders import PyPDFLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_community.vectorstores import FAISS
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser


# ì´ˆê¸°í™” ì‘ì—… (ì„œë²„ ì‹œì‘ ì‹œ 1íšŒë§Œ ì‹¤í–‰)
# ì„œë²„ ê³¼ë¶€í•˜ ë°©ì§€. ê²€ìƒ‰ ì†ë„ í–¥ìƒ ëª©ì . ëª¨ë“  ì¤€ë¹„ ë§ˆì¹œ ê²€ìƒ‰ê¸° ë¦¬í„´.
def prepare_rag_engine(pdf_path: str):
    # PDF ë¡œë“œ
    try:
        loader = PyPDFLoader(file_path=pdf_path)
        raw_docs = loader.load()
        print(f"PDF ë¡œë“œ ì„±ê³µ: ì´ {len(raw_docs)} í˜ì´ì§€.")
    except Exception as e:
        print(f"PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ X.: {e}")
        return None

    # ì²­í¬ ë¶„í• 
    if raw_docs:
        text_splitter = RecursiveCharacterTextSplitter(
            chunk_size=1000,
            chunk_overlap=200
        )
        docs = text_splitter.split_documents(raw_docs)
        print(f"{len(docs)}ê°œì˜ ë¬¸ì„œ ì¡°ê° ìƒì„±.")
    else:
        print("PDF ë¹„ì–´ ìˆìŒ. ì²­í¬ ì‹¤íŒ¨.")
        return None

    # ë²¡í„° DB ë° ê²€ìƒ‰ê¸° ìƒì„±
    try:
        embeddings = GoogleGenerativeAIEmbeddings(model="models/embedding-001")

        # ë²¡í„° DB ìƒì„± ë° ì €ì¥
        db = FAISS.from_documents(docs, embeddings)

        # ê²€ìƒ‰ê¸° ì„¸íŒ…
        retriever = db.as_retriever(search_kwargs={"k": 10})

        print(f"ë²¡í„° DB ë° ê²€ìƒ‰ê¸° ìƒì„± ì™„ë£Œ.")
        return retriever

    except Exception as e:
        print(f"ë²¡í„° DB ìƒì„± ì‹¤íŒ¨.: {e}")
        return None

# ì„œë²„ êµ¬ë™ ì¸ì›ì˜ ë¡œì»¬ì— ì €ì¥ëœ ê²½ë¡œ
PDF_FILE_PATH = r"C:\capstone\backend\real_used_in_RAG_policy.pdf"

# g_ëŠ” ì „ì—­ë³€ìˆ˜ë¥¼ ì˜ë¯¸í•¨.
g_retriever_pdf = prepare_rag_engine(PDF_FILE_PATH)

# LLM ë° í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™”.
try:
    g_llm = ChatGoogleGenerativeAI(model="gemini-2.5-pro")

    prompt_template = """
    ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ 'ì—¬í–‰ ì»¨ì„¤í„´íŠ¸'ì…ë‹ˆë‹¤.
    ì•„ë˜ ì œê³µëœ [ì»¨í…ìŠ¤íŠ¸]ì„ ë°”íƒ•ìœ¼ë¡œ, ê³ ê°ì„ ìœ„í•œ 'ì—¬í–‰ ì¶”ì²œ ë³´ê³ ì„œ'ë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

    [ì‘ì„± ê·œì¹™]
    1. ë°˜ë“œì‹œ ì•„ë˜ [ì»¨í…ìŠ¤íŠ¸]ì— í¬í•¨ëœ ìƒí’ˆê³¼ ì •ë³´ë§Œì„ ê·¼ê±°ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
    2. ì¶”ì²œëœ ê° ìƒí’ˆì´ 'ì™œ' ì¢‹ì€ì§€, PDF ìƒì„¸ ì„¤ëª…ì„ ì¸ìš©í•˜ì—¬ ì„¤ë“ë ¥ ìˆê²Œ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
    3. ë³´ê³ ì„œ í†¤ì€ ì •ì¤‘í•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    4. ë°˜ë“œì‹œ í”„ë¡¬í”„íŠ¸ í•˜ë‹¨ì— ìˆëŠ” [ì¶œë ¥ í˜•ì‹ ê°€ì´ë“œ]ë¥¼ ì—„ê²©í•˜ê²Œ ì¤€ìˆ˜í•˜ì—¬ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
    5. [ì¤‘ìš”] "PDFì— ë”°ë¥´ë©´", "ë¬¸ì„œì— ì˜í•˜ë©´", "ìƒì„¸ ì„¤ëª… ì¸ìš©"ê³¼ ê°™ì€ í‘œí˜„ì€ **ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.** ë§ˆì¹˜ ë‹¹ì‹ ì´ ì§ì ‘ ì•Œê³  ìˆëŠ” ì§€ì‹ì¸ ê²ƒì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ ì„œìˆ í•˜ì‹­ì‹œì˜¤.
    6. [ê°€ë…ì„±] ë¬¸ë‹¨ê³¼ ë¬¸ë‹¨ ì‚¬ì´, ë¦¬ìŠ¤íŠ¸ í•­ëª© ì‚¬ì´ì—ëŠ” **ë°˜ë“œì‹œ 'ë¹ˆ ì¤„(Empty Line)'ì„ í•˜ë‚˜ì”© ì¶”ê°€**í•˜ì—¬ ë¹½ë¹½í•˜ì§€ ì•Šê²Œ ì‘ì„±í•˜ì‹­ì‹œì˜¤. (ì—”í„°ë¥¼ ë‘ ë²ˆ ì¹˜ëŠ” íš¨ê³¼)

    [ì»¨í…ìŠ¤íŠ¸]

    ### ì„œë²„ ì¶”ì²œ ìƒí’ˆ (í•µì‹¬ ì •ë³´)
    {server_product_context}

    ###  pdf ë¶€ì—° ì„¤ëª….
    {pdf_description_context}

    [ì§ˆë¬¸]
    {question}
    
    [ì¶œë ¥ í˜•ì‹ ê°€ì´ë“œ]
    ë‹¹ì‹ ì˜ ë‹µë³€ì€ **ë°˜ë“œì‹œ** ì•„ë˜ì˜ ë§ˆí¬ë‹¤ìš´(Markdown) í˜•ì‹ì„ ê·¸ëŒ€ë¡œ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤. 
    **ê°€ë…ì„±ì„ ìœ„í•´ ëª¨ë“  í•­ëª©ê³¼ ë‹¨ë½ ì‚¬ì´ì—ëŠ” 'ë‘ ë²ˆì˜ ì¤„ë°”ê¿ˆ'ì„ ì‚¬ìš©í•˜ì—¬ í™•ì‹¤í•œ ê³µë°±(ë¹ˆ ì¤„)ì„ ë„£ìœ¼ì‹­ì‹œì˜¤.**
    ë‹¤ë¥¸ ì‚¬ì¡±(ì˜ˆ: "ë„¤, ì•Œê² ìŠµë‹ˆë‹¤")ì„ ë¶™ì´ì§€ ë§ê³ , ì•„ë˜ ì„œì‹ì˜ (ê´„í˜¸) ë‚´ìš©ì„ ì±„ì›Œ ë³´ê³ ì„œë¥¼ ì™„ì„±í•˜ì‹­ì‹œì˜¤.

    # (ë§¤ë ¥ì ì¸ ì—¬í–‰ ë³´ê³ ì„œ ì œëª©)
    

    -------------------------------------------------------------------------------------------------


    ## ì¶”ì²œ ìš”ì•½
    
    
    (ê³ ê°ì—ê²Œ ì „í•˜ëŠ” ì •ì¤‘í•œ ì¸ì‚¬ë§ê³¼ ì „ì²´ì ì¸ ì¶”ì²œ ì´ìœ ë¥¼ ìš”ì•½)
    

    -------------------------------------------------------------------------------------------------


    ## ì¶”ì²œ ìƒí’ˆ ìƒì„¸
    
    
    ### ğŸ† (ìƒí’ˆëª… 1)
    
    
    - ì¶”ì²œ í¬ì¸íŠ¸: (ì´ ìƒí’ˆì˜ í•µì‹¬ ì¥ì ì„ êµµê²Œ ê°•ì¡°)
    
    
    - ìƒì„¸ ì„¤ëª…:
      (PDF ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ìƒì„¸ ì„¤ëª…. "PDFì— ë”°ë¥´ë©´", "ë¬¸ì„œì— ì˜í•˜ë©´" ê°™ì€ ë§ ì—†ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì„œìˆ í•  ê²ƒ. ë¬¸ì¥ì´ ê¸¸ì–´ì§€ë©´ ì ì ˆíˆ ì¤„ì„ ë°”ê¾¸ì–´ ì‘ì„±.)
    
    
    ### ğŸ† (ìƒí’ˆëª… 2)
    
    
    - ì¶”ì²œ í¬ì¸íŠ¸: (ì´ ìƒí’ˆì˜ í•µì‹¬ ì¥ì ì„ êµµê²Œ ê°•ì¡°)
    
    
    - ìƒì„¸ ì„¤ëª…:
      (PDF ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ìƒì„¸ ì„¤ëª…. "PDFì— ë”°ë¥´ë©´", "ë¬¸ì„œì— ì˜í•˜ë©´" ê°™ì€ ë§ ì—†ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì„œìˆ í•  ê²ƒ. ë¬¸ì¥ì´ ê¸¸ì–´ì§€ë©´ ì ì ˆíˆ ì¤„ì„ ë°”ê¾¸ì–´ ì‘ì„±.)

    (ìƒí’ˆì´ ë” ìˆë‹¤ë©´ ìœ„ì™€ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ ì¶”ê°€. ìƒí’ˆ ì‚¬ì´ì—ë„ ë¹ˆ ì¤„ í•„ìˆ˜)
    

    -------------------------------------------------------------------------------------------------


    ## ì¢…í•© ì˜ê²¬
    
    
    (ì „ë¬¸ê°€ë¡œì„œì˜ ë§ˆë¬´ë¦¬ ì˜ê²¬ ë° ì—¬í–‰ íŒ)
    """

    # LangChainì´ ì´í•´í•  ìˆ˜ ìˆëŠ” í”„ë¡¬í”„íŠ¸ ì–‘ì‹ìœ¼ë¡œ ë³€í™˜.
    g_prompt = ChatPromptTemplate.from_template(prompt_template)

    # ìƒì„± ì²´ì¸ êµ¬ì„±. ìƒí’ˆëª… ê°œìˆ˜ë§Œí¼ ê²€ìƒ‰í•´ì•¼ í•˜ë¯€ë¡œ ê²€ìƒ‰ê¸°ëŠ” í•´ë‹¹ ì²´ì¸ì„œ ì œì™¸.
    g_chain = g_prompt | g_llm | StrOutputParser()
    print("ì²´ì¸ ì¤€ë¹„ ì™„ë£Œ.\n")

except Exception as e:
    print(f"LLM ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
    g_chain = None

# ì„œë²„ê°€ í˜¸ì¶œí•  í•¨ìˆ˜. Dictìœ¼ë¡œ êµ¬ì„±ëœ Listê°€ ì¸í’‹. strê°€ ì•„ì›ƒí’‹.
def create_report(product_data_list: List[Dict]) -> str:
    # ì•ˆì „ ì¥ì¹˜
    if not g_retriever_pdf or not g_chain:
        return "RAG ì—”ì§„ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."

    if not product_data_list:
        return "ì¶”ì²œí•  ìƒí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."

    print(f"\në³´ê³ ì„œ ìƒì„± ìš”ì²­ ë°›ìŒ (ìƒí’ˆ {len(product_data_list)}ê°œ)")

    # PDFì„œ ë¶€ì—° ì„¤ëª… (ìˆ˜ë™ Loop)
    # ìƒí’ˆëª…ì— ëŒ€í•œ ì„¤ëª… ë‹´ì„ ë¦¬ìŠ¤íŠ¸.
    pdf_descriptions_list = []

    # ìƒí’ˆëª… ê°œìˆ˜ë§Œí¼ ì‹¤í–‰.
    for product in product_data_list:
        # ë”•ì…”ë„ˆë¦¬ì—ì„œ 'product_name' ì¶”ì¶œ (í‚¤ ì´ë¦„ì´ ë‹¤ë¥´ë©´ ìˆ˜ì • í•„ìš”)
        p_name = product.get("product_name", "ì´ë¦„ XX.")
        print(f"  - '{p_name}' ìƒì„¸ ì •ë³´ ê²€ìƒ‰ ", end="")

        try:
            # ê²€ìƒ‰ì–´(ìƒí’ˆëª…)ë¡œ PDF ê²€ìƒ‰ê¸° í˜¸ì¶œ. ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì €ì¥.
            retrieved_chunks = g_retriever_pdf.invoke(p_name)

            if retrieved_chunks:
                # ê²€ìƒ‰ëœ ì²­í¬ë“¤ì„ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ë¡œ í•©ì¹¨.
                combined_text = "\n".join([doc.page_content for doc in retrieved_chunks])
                pdf_descriptions_list.append(f"ìƒí’ˆëª…: {p_name}\n[ìƒì„¸ ì„¤ëª…]:\n{combined_text}\n")
            else:
                pdf_descriptions_list.append(f"ìƒí’ˆëª…: {p_name}\n(ìƒì„¸ ì„¤ëª… ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ X)\n")
                print("ì‹¤íŒ¨.")

        except Exception as e:
            print(f" ì˜¤ë¥˜ ë°œìƒ: {e}")
            pdf_descriptions_list.append(f"ìƒí’ˆëª…: {p_name}\n(ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ)\n")

    # ì„œë²„ê°€ ì¤€ ìƒí’ˆ ì •ë³´ (ë¬¸ìì—´ë¡œ ë³€í™˜)
    server_context_str = ""
    for p in product_data_list:
        server_context_str += f"- {p}\n"

    # PDF ë¶€ì—° ì„¤ëª… (ë¬¸ìì—´ë¡œ ë³€í™˜)
    pdf_context_str = "\n".join(pdf_descriptions_list)

    # ìµœì¢… ì…ë ¥ê°’ êµ¬ì„±.
    final_inputs = {
        "server_product_context": server_context_str,
        "pdf_description_context": pdf_context_str,
        "question": "ìœ„ ì •ë³´ë¥¼ ì¢…í•©í•˜ì—¬ ê³ ê°ì—ê²Œ ìµœì ì˜ ì—¬í–‰ ê³„íšì„ ì œì•ˆí•˜ëŠ” ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì¤˜."
    }

    # LLM í˜¸ì¶œ
    report_text = g_chain.invoke(final_inputs)

    return report_text